# Firestore Database Schema - MedipolApp

## Overview

This document defines the complete Firestore database schema for MedipolApp, including all collections, document structures, relationships, security considerations, and indexing strategies.

---

## Collection Architecture

### 1. **users/** Collection üë§

**Purpose**: Store user profiles, preferences, and authentication data
**Document ID**: Firebase UID (Auto-generated by Firebase Auth)

#### Document Structure:
```typescript
{
  // Microsoft OAuth Data / Microsoft OAuth Verileri
  microsoftId: string,                    // Microsoft Graph API user ID
  email: string,                          // Primary email address
  displayName: string,                    // Full display name
  firstName?: string,                     // Given name from Microsoft
  lastName?: string,                      // Surname from Microsoft
  userPrincipalName: string,             // Microsoft UPN (unique identifier)
  
  // University-specific Data / √úniversiteye √∂zel veriler
  studentId?: string,                     // √ñƒürenci numarasƒ± (if student)
  employeeId?: string,                   // Personel numarasƒ± (if staff)
  department?: string,                   // B√∂l√ºm/Department
  faculty?: string,                      // Fak√ºlte/Faculty
  year?: number,                         // Sƒ±nƒ±f/Year (for students)
  semester?: number,                     // D√∂nem/Semester
  
  // System Data / Sistem verileri
  role: 'student' | 'staff' | 'admin' | 'guest',
  permissions: string[],                 // ['read_announcements', 'write_grades', etc.]
  isActive: boolean,                     // Account status
  
  // Preferences / Tercihler
  preferences: {
    language: 'tr' | 'en',
    notifications: {
      announcements: boolean,
      grades: boolean,
      cafeteria: boolean,
      events: boolean,
      pushEnabled: boolean,
      emailEnabled: boolean
    },
    theme: 'light' | 'dark' | 'system',
    timezone: string                     // 'Europe/Istanbul'
  },
  
  // Profile Data / Profil verileri
  profile: {
    profilePhotoUrl?: string,            // Firebase Storage URL
    bio?: string,
    phoneNumber?: string,
    emergencyContact?: {
      name: string,
      phone: string,
      relationship: string
    },
    socialLinks?: {
      linkedin?: string,
      instagram?: string,
      twitter?: string
    }
  },
  
  // Timestamps / Zaman damgalarƒ±
  createdAt: Timestamp,
  updatedAt: Timestamp,
  lastLoginAt: Timestamp,
  lastActiveAt: Timestamp
}
```

#### Subcollections:
- **`users/{userId}/activities`**: User activity logs
- **`users/{userId}/notifications`**: Personal notification history
- **`users/{userId}/favorites`**: Favorited content (announcements, events, etc.)

---

### 2. **announcements/** Collection üì¢

**Purpose**: Store university announcements and news
**Document ID**: Auto-generated

#### Document Structure:
```typescript
{
  // Content / ƒ∞√ßerik
  title: string,                         // Duyuru ba≈ülƒ±ƒüƒ±
  content: string,                       // HTML/Markdown formatted content
  summary?: string,                      // Short description for previews
  
  // Media / Medya
  images?: string[],                     // Firebase Storage URLs
  attachments?: {
    name: string,
    url: string,                         // Firebase Storage URL
    type: string,                        // 'pdf', 'doc', 'image', etc.
    size: number                         // File size in bytes
  }[],
  
  // Targeting / Hedefleme
  targetAudience: {
    roles: ('student' | 'staff' | 'admin' | 'all')[],
    departments?: string[],              // Specific departments
    faculties?: string[],               // Specific faculties
    years?: number[],                   // Specific class years (for students)
    userIds?: string[]                  // Specific users (for private announcements)
  },
  
  // Classification / Sƒ±nƒ±flandƒ±rma
  category: 'general' | 'academic' | 'administrative' | 'social' | 'urgent' | 'event',
  priority: 'low' | 'medium' | 'high' | 'critical',
  tags?: string[],                       // ['exam', 'registration', 'deadline', etc.]
  
  // Publishing / Yayƒ±nlama
  status: 'draft' | 'published' | 'archived' | 'scheduled',
  publishAt?: Timestamp,                 // For scheduled announcements
  expiresAt?: Timestamp,                // Auto-archive date
  
  // Interaction / Etkile≈üim
  viewCount: number,
  likeCount: number,
  commentCount: number,
  shareCount: number,
  
  // Author / Yazar
  createdBy: string,                     // User ID
  authorName: string,                    // Display name at time of creation
  authorRole: string,                    // Role at time of creation
  
  // Timestamps / Zaman damgalarƒ±
  createdAt: Timestamp,
  updatedAt: Timestamp,
  
  // SEO & Search / SEO ve arama
  searchKeywords: string[],              // For search optimization
  slug?: string                          // URL-friendly identifier
}
```

#### Subcollections:
- **`announcements/{announcementId}/comments`**: User comments
- **`announcements/{announcementId}/reactions`**: Likes, shares, etc.
- **`announcements/{announcementId}/views`**: View tracking per user

---

### 3. **cafeteria/** Collection üçΩÔ∏è

**Purpose**: Store daily menus, meal information, and cafeteria data
**Document ID**: Date in YYYY-MM-DD format

#### Document Structure:
```typescript
{
  date: string,                          // 'YYYY-MM-DD' format
  
  // Meal Plans / Yemek planlarƒ±
  meals: {
    breakfast?: {
      available: boolean,
      servingTime: {
        start: string,                   // 'HH:mm' format
        end: string
      },
      items: MenuItem[]
    },
    lunch: {
      available: boolean,
      servingTime: {
        start: string,
        end: string
      },
      items: MenuItem[]
    },
    dinner?: {
      available: boolean,
      servingTime: {
        start: string,
        end: string
      },
      items: MenuItem[]
    }
  },
  
  // Special Information / √ñzel bilgiler
  specialNotes?: string,                 // Daily special notes
  allergenWarnings?: string[],          // Common allergen alerts
  isHoliday: boolean,                   // Public holiday indicator
  
  // Metadata / Metadata
  lastUpdated: Timestamp,
  updatedBy: string                     // User ID who last updated
}

// MenuItem Interface
interface MenuItem {
  name: string,                         // Dish name
  nameEn?: string,                     // English name
  description?: string,                // Description
  category: 'soup' | 'main' | 'side' | 'salad' | 'dessert' | 'beverage',
  
  // Nutritional Info / Beslenme bilgileri
  nutrition?: {
    calories?: number,
    protein?: number,                   // grams
    carbs?: number,                    // grams
    fat?: number,                      // grams
    fiber?: number,                    // grams
    sodium?: number                    // mg
  },
  
  // Dietary Info / Diyet bilgileri
  dietary: {
    isVegetarian: boolean,
    isVegan: boolean,
    isGlutenFree: boolean,
    isLactoseFree: boolean,
    isHalal: boolean
  },
  
  // Allergens / Alerjenler
  allergens?: ('gluten' | 'dairy' | 'nuts' | 'eggs' | 'soy' | 'fish' | 'shellfish')[],
  
  // Additional Info / Ek bilgiler
  imageUrl?: string,                    // Firebase Storage URL
  price?: number,                       // If applicable
  availability: 'available' | 'limited' | 'unavailable',
  rating?: {
    average: number,                    // 1-5 stars
    count: number                       // Number of ratings
  }
}
```

#### Subcollections:
- **`cafeteria/{date}/ratings`**: User ratings for meals
- **`cafeteria/{date}/feedback`**: User feedback and comments

---

### 4. **calendar/** Collection üìÖ

**Purpose**: Store academic calendar events, exams, and important dates
**Document ID**: Auto-generated

#### Document Structure:
```typescript
{
  // Event Details / Etkinlik detaylarƒ±
  title: string,
  description?: string,
  location?: string,
  locationDetails?: {
    building?: string,
    room?: string,
    campus?: string,
    coordinates?: {
      latitude: number,
      longitude: number
    }
  },
  
  // Timing / Zamanlama
  startDate: Timestamp,
  endDate: Timestamp,
  isAllDay: boolean,
  timezone: string,                      // 'Europe/Istanbul'
  
  // Recurrence / Tekrarlama
  recurrence?: {
    type: 'daily' | 'weekly' | 'monthly' | 'yearly',
    interval: number,                    // Every X days/weeks/months/years
    endDate?: Timestamp,                // When recurrence ends
    daysOfWeek?: number[],              // [0,1,2,3,4,5,6] for weekly recurrence
    exceptions?: Timestamp[]             // Dates to skip
  },
  
  // Event Type / Etkinlik t√ºr√º
  type: 'exam' | 'lecture' | 'seminar' | 'meeting' | 'holiday' | 'deadline' | 'social' | 'academic',
  category: 'academic' | 'administrative' | 'social' | 'deadline' | 'exam',
  
  // Targeting / Hedefleme
  targetAudience: {
    roles: ('student' | 'staff' | 'admin' | 'all')[],
    departments?: string[],
    faculties?: string[],
    years?: number[],
    courseIds?: string[],               // Specific courses
    userIds?: string[]                  // Specific users
  },
  
  // Additional Info / Ek bilgiler
  priority: 'low' | 'medium' | 'high',
  color?: string,                       // Hex color for calendar display
  tags?: string[],
  
  // Exam-specific fields (if type === 'exam')
  examDetails?: {
    courseCode: string,
    courseName: string,
    examType: 'midterm' | 'final' | 'quiz' | 'makeup',
    duration: number,                   // Minutes
    instructions?: string,
    materials?: string[]                // Allowed materials
  },
  
  // Notification settings / Bildirim ayarlarƒ±
  reminders?: {
    time: number,                       // Minutes before event
    method: 'push' | 'email' | 'both'
  }[],
  
  // Status / Durum
  status: 'scheduled' | 'ongoing' | 'completed' | 'cancelled' | 'postponed',
  
  // Interaction / Etkile≈üim
  attendeeCount?: number,
  maxAttendees?: number,
  registrationRequired: boolean,
  registrationDeadline?: Timestamp,
  
  // Creator / Olu≈üturan
  createdBy: string,                    // User ID
  authorName: string,
  authorRole: string,
  
  // Timestamps / Zaman damgalarƒ±
  createdAt: Timestamp,
  updatedAt: Timestamp
}
```

#### Subcollections:
- **`calendar/{eventId}/attendees`**: Event attendee list
- **`calendar/{eventId}/reminders`**: Custom user reminders

---

### 5. **grades/** Collection üìä

**Purpose**: Store student grades and academic records
**Document ID**: `{userId}` (student's Firebase UID)

#### Document Structure:
```typescript
{
  // Student Info / √ñƒürenci bilgileri
  studentId: string,                    // √ñƒürenci numarasƒ±
  userId: string,                       // Firebase UID
  
  // Academic Info / Akademik bilgiler
  currentSemester: number,
  currentYear: number,
  enrollmentYear: number,
  expectedGraduationYear: number,
  
  // GPA Calculations / GPA hesaplamalarƒ±
  gpa: {
    overall: number,                    // Overall GPA
    semester: {
      [semesterKey: string]: number     // 'YYYY-S' format (e.g., '2024-1')
    }
  },
  
  // Courses / Dersler
  courses: {
    [courseId: string]: CourseGrade
  },
  
  // Academic Status / Akademik durum
  academicStatus: 'active' | 'probation' | 'suspended' | 'graduated' | 'withdrawn',
  
  // Timestamps / Zaman damgalarƒ±
  lastUpdated: Timestamp,
  updatedBy: string                     // User ID who last updated (admin/system)
}

// CourseGrade Interface
interface CourseGrade {
  // Course Info / Ders bilgileri
  courseCode: string,                   // 'CSE101'
  courseName: string,
  courseNameEn?: string,
  credits: number,
  semester: string,                     // 'YYYY-S' format
  year: number,
  
  // Instructor / √ñƒüretim g√∂revlisi
  instructor: {
    name: string,
    email?: string,
    department: string
  },
  
  // Grades / Notlar
  grades: {
    midterm1?: {
      score: number,                    // 0-100
      weight: number,                   // Percentage weight (0-100)
      date: Timestamp
    },
    midterm2?: {
      score: number,
      weight: number,
      date: Timestamp
    },
    final?: {
      score: number,
      weight: number,
      date: Timestamp
    },
    assignments?: {
      [assignmentId: string]: {
        name: string,
        score: number,
        maxScore: number,
        weight: number,
        date: Timestamp,
        feedback?: string
      }
    },
    quizzes?: {
      [quizId: string]: {
        name: string,
        score: number,
        maxScore: number,
        weight: number,
        date: Timestamp
      }
    },
    participation?: {
      score: number,
      weight: number,
      notes?: string
    }
  },
  
  // Final Results / Final sonu√ßlar
  finalGrade: {
    letterGrade: 'AA' | 'BA' | 'BB' | 'CB' | 'CC' | 'DC' | 'DD' | 'FD' | 'FF' | 'I' | 'W',
    numericGrade: number,               // 0-4.0 scale
    percentage: number,                 // 0-100
    isPassed: boolean,
    status: 'completed' | 'in_progress' | 'withdrawn' | 'incomplete'
  },
  
  // Additional Info / Ek bilgiler
  attendance?: {
    present: number,
    absent: number,
    late: number,
    excused: number,
    total: number
  },
  
  // Metadata / Metadata
  lastUpdated: Timestamp,
  isVisible: boolean,                   // Can student see this grade?
  notes?: string                        // Additional notes from instructor
}
```

---

## Additional Collections

### 6. **notifications/** Collection üîî

**Purpose**: Store push notifications and system messages
**Document ID**: Auto-generated

```typescript
{
  // Recipient / Alƒ±cƒ±
  userId: string,                       // Target user ID
  
  // Content / ƒ∞√ßerik
  title: string,
  body: string,
  data?: {[key: string]: any},         // Additional payload data
  
  // Type & Source / T√ºr ve kaynak
  type: 'announcement' | 'grade' | 'event' | 'cafeteria' | 'system' | 'reminder',
  sourceId?: string,                    // ID of related document
  sourceCollection?: string,            // Collection name of related document
  
  // Status / Durum
  status: 'pending' | 'sent' | 'delivered' | 'read' | 'failed',
  
  // Delivery / Teslimat
  channels: ('push' | 'email' | 'in_app')[],
  deliveryAttempts: number,
  
  // Timestamps / Zaman damgalarƒ±
  createdAt: Timestamp,
  scheduledFor?: Timestamp,             // For scheduled notifications
  sentAt?: Timestamp,
  readAt?: Timestamp
}
```

### 7. **system/** Collection ‚öôÔ∏è

**Purpose**: Store system configuration and metadata
**Document ID**: Configuration key

```typescript
{
  // App Configuration / Uygulama konfig√ºrasyonu
  'app_config': {
    maintenanceMode: boolean,
    minimumAppVersion: string,
    forceUpdateVersion: string,
    supportedLanguages: string[],
    defaultLanguage: string,
    timezone: string,
    academicYear: string,              // '2024-2025'
    currentSemester: number,
    semesterStartDate: Timestamp,
    semesterEndDate: Timestamp
  },
  
  // Feature Flags / √ñzellik bayraklarƒ±
  'feature_flags': {
    gradesEnabled: boolean,
    cafeteriaEnabled: boolean,
    calendarEnabled: boolean,
    notificationsEnabled: boolean,
    chatEnabled: boolean,
    fileUploadsEnabled: boolean
  },
  
  // University Data / √úniversite verileri
  'university_data': {
    name: string,
    nameEn: string,
    address: string,
    phone: string,
    email: string,
    website: string,
    campuses: {
      [campusId: string]: {
        name: string,
        address: string,
        coordinates: {
          latitude: number,
          longitude: number
        }
      }
    },
    departments: string[],
    faculties: string[]
  }
}
```

---

## Security Rules Strategy

### Core Principles:
1. **Users can only access their own data**
2. **Role-based access for administrative functions**
3. **Public read access for announcements and general info**
4. **Strict write permissions**

### Key Rules:
- Students can read their own grades only
- Staff can read grades for their assigned courses/students
- Admins can read/write announcements
- All authenticated users can read cafeteria menus and calendar events
- Only system/admin can write to grades collection

---

## Indexing Strategy

### Required Indexes:
1. **announcements**: `targetAudience.roles`, `status`, `createdAt`
2. **calendar**: `targetAudience.roles`, `startDate`, `type`
3. **cafeteria**: `date` (automatic)
4. **users**: `role`, `department`, `isActive`
5. **notifications**: `userId`, `status`, `createdAt`

### Composite Indexes:
- **announcements**: `[status, targetAudience.roles, createdAt]`
- **calendar**: `[type, startDate, targetAudience.roles]`
- **notifications**: `[userId, status, createdAt]`

---

## Data Validation Rules

### Required Fields:
- All documents must have `createdAt` and `updatedAt` timestamps
- User documents must have valid `role` and `email`
- Announcements must have `title`, `content`, and `targetAudience`
- Calendar events must have `title`, `startDate`, and `type`

### Data Constraints:
- Email addresses must be validated
- Dates must be in future for scheduled events
- GPA values must be between 0.0-4.0
- User roles must be from predefined enum

---

This schema provides a comprehensive foundation for the MedipolApp backend, ensuring scalability, security, and efficient data access patterns. 